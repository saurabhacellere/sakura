<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML lang="ja">
<HEAD>
<META http-equiv="Content-Type" content="text/html; charset=Shift_JIS">
<link rel="stylesheet" href="dsk_sakura.css" type="text/css">
<TITLE>改行コードについて</TITLE>
</HEAD>
<BODY>
<script type="text/javascript">
<!--
document.writeln('<OBJECT id="aaHHCtlCloseWin" type="application/x-oleobject"');
document.writeln(' classid="clsid:adb880a6-d8ff-11cf-9377-00aa003b7a11"> ');
document.writeln(' <PARAM name="Command" value="Close"> ');
document.writeln('</OBJECT> ');

document.onkeypress=CheckClose;

function CheckClose() {
if (window.event.keyCode == 27)
aaHHCtlCloseWin.Click(); }
// -->
</script>
<h2>改行コードについて</h2>
<h3>取り扱える改行コード</h3>
複数の改行コードが混在したファイルも取り扱えるようにする<br>
<div class=li200>
<strike>CR00LF00	( 0d 00 0a 00 )</strike>	<img src="images/hint.png">廃止しました。(sakura:1.3.4.1)<br>
CRLF	( 0d 0a )<br>
LFCR	( 0a 0d )<br>
CR	( 0d )<br>
LF	( 0a )<br>
</div><br>
<h3>ファイル読み込み時の処理</h3>
ファイルを読み込む際は改行単位で行バッファに追加していく。<br>
<ul>
<li>ファイルの先頭から1バイトずつサーチし、CRかLFが出現するまでループする。</li>
<li>取り扱える改行コードのどれに該当するのか調べる。</li>
<li>行テキストと改行コードの情報を行バッファに格納する。</li>
<li>ファイルの終わりまで繰り返す。</li>
<li>ファイルの最後に改行なしの行がある場合も、行テキストと改行コードなしの情報を行バッファに格納する。</li>
<li>改行コードの種類を判別する。これにより、編集時にEnter等で挿入される改行コードを決定する。</li>
<li><strike>複数の改行コードが検出された場合は、編集時にEnter等で挿入される改行コードを、ユーザーが一覧から一つ選択する。<br>
<b><font color="blue">現在は選択できない(「挿入すべき改行コード」をデータとして内部的に保持しているが、変更するインターフェイスが用意されていないので)。</font></strike></li>
<li><strike>デフォルトでは“そのファイルを開いた時、１行目の末尾に使われていた改行コード”になる。</b></strike></li>
<li><font color="blue">ファイルを開いた後、変更するコマンドを追加しました。</font></b></li>
</ul>
<br>
<h3>表示レイアウト情報作成時の処理</h3>
<div class=li200>
行バッファから<em>TAB幅、コメント記号、文字列記述方法、折り返し桁数、等</em>をもとに、表示レイアウト情報を作成する（レイアウトバッファ）<br>
</div><br>
<h3>クリップボードへコピーする処理</h3>
■<b><font color="blue">矩形選択時</font></b><br>
<div class=li200>
	"<font color="red">MSDEVColumnSelect</font>"形式のデータをクリップボードに格納<br>
	<ul>
		<li>データ内容不定</li>
	</ul>

	<font color="red">CF_OEMTEXT</font>形式のデータをクリップボードに格納<br>
	<ul>
		<li>選択領域の各行が改行を含む場合はCRLFに変換、改行を含まない場合はCRLFを付加</li>
		<li>すべての改行コードをCRLFに統一</li>
		<li>null文字(0x00)以降切捨て</li>
	</ul>

	"<font color="red">SAKURAClip</font>"形式のデータをクリップボードに格納<br>
	<ul>
		<li>先頭0〜3の4バイトがint型のデータ長(n)</li>
		<li>先頭4〜4 + n - 1 のnバイトがデータ(バイナリ含む)</li>
		<li>選択領域の各行が改行を含む場合はそのまま、改行を含まない場合はCRLFを付加</li>
	</ul>
</div>

■<b><font color="blue">線形選択時</font></b><br>
<div class=li200>
	<font color="red">CF_OEMTEXT</font>形式のデータをクリップボードに格納
	<ul>
		<li>改行コードは元テキストの状態を保持する。</li>
		<li>null文字(0x00)以降切捨て</li>
	</ul>
	"<font color="red">SAKURAClip</font>"形式のデータをクリップボードに格納
	<ul>
		<li>先頭0〜3の4バイトがint型のデータ長(n)</li>
		<li>先頭4〜4 + n - 1 のnバイトがデータ(バイナリ含む)</li>
	</ul>
</div>
<br>

<h3>クリップボードから貼り付ける処理</h3>
<font color="green">クリップボードの形式を調べる</font><br>
<div class=li200>
	"<font color="red">MSDEVColumnSelect</font>"形式がある場合
	<ul>
		<li>矩形貼り付けとする</li>
	</ul>
	"<font color="red">SAKURAClip</font>"形式がある場合
	<ul>
		<li>そのデータを取り出しそのまま貼り付けデータとする。</li>
	</ul>
	<font color="red">CF_UNICODETEXT</font>形式のデータがある場合
	<ul>
		<li>サクラエディタ内部のSJIS変換ロジックを使用してShiftJISに変換したものを貼り付けデータとする。</li>
			<li>改行コードは元テキストの状態を保持する。</li>
			<li>null文字(0x00)以降切捨て</li>
	</ul>
	<font color="red">CF_OEMTEXT</font>形式のデータがある場合
	<ul>
		<li>そのデータを取り出しそのまま貼り付けデータとする。</li>
		<li>改行コードは元テキストの状態を保持する。</li>
		<li>null文字(0x00)以降切捨て</li>
	</ul>
</div><br>
<h3>[Enter] キー入力時の処理</h3>
<div class=li200>挿入される改行コードの種類はファイル読み込み時に決定する。<br>
[Enter] キー入力時は、その改行コードに変換して格納する。<br>
</div><br>

<h3>アンドゥ・リドゥバッファへの改行コード格納形式</h3>
<div class=li200>
前バージョンは改行コードを\rで表現していた。<br>
新バージョンはCRLFやLFCR等をそのまま格納する。<br>
バッファからの取り出し処理の際、複数種類の改行コードを判別する。<br>
</div><br>

<h3>編集画面での記号表記について</h3>
1.6.0.0より改行コードの表記が変わりましたので、ご注意ください。
<ul>
<li><b>1.5.17.0以前</b>：LF←，CR↓</li>
<li><b>1.6.0.0以降</b>：LF↓，CR←</li>
</ul>
なお、これは以前のバージョンが間違えていたわけではなく、過去の経緯によるものなので仕様変更と理解してください。<br>

</BODY></HTML>
