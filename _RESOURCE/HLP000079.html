<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML lang="ja">
<HEAD>
<META http-equiv="Content-Type" content="text/html; charset=Shift_JIS">
<link rel="stylesheet" href="dsk_sakura.css" type="text/css">
<TITLE>VisualStyle化／UAC対応化</TITLE>
<META NAME="MS-HKWD" CONTENT="VisualStyle化">
<META NAME="MS-HKWD" CONTENT="UAC対応化">
<META NAME="MS-HKWD" CONTENT="sakura.exe.manifest">
</HEAD>
<BODY>
<script type="text/javascript">
<!--
document.writeln('<OBJECT id="aaHHCtlCloseWin" type="application/x-oleobject"');
document.writeln(' classid="clsid:adb880a6-d8ff-11cf-9377-00aa003b7a11"> ');
document.writeln(' <PARAM name="Command" value="Close"> ');
document.writeln('</OBJECT> ');

document.onkeypress=CheckClose;

function CheckClose() {
if (window.event.keyCode == 27)
aaHHCtlCloseWin.Click(); }
// -->
</script>
<h2>VisualStyle化</h2>
XP以降のOSでは<em>sakura.exe.manifest</em>を設置するとVisualStyle化できます。<br>
<br>
VistaではすぐにVisualStyleが適用されないことがあるようです。その場合は一回だけサクラエディタを互換モードで起動すると次回からVisualStyleが適用されます。<br>
<br>
<small>*sakura.exe.manifestの内容は頁末参照</small><br>

<h2>UAC対応化</h2>
UAC(User Account Control)はVista以降のOSに実装された安全性を高めるための機能ですが、詳しい説明は割愛します。<br>
<br>
特に設定を行わずにサクラエディタを単品で起動させると、UACのポリシーに対応しないモードで動作するため、VirtualStore(互換のための機能)が有効になります。
<em>sakura.exe.manifest</em>を設置することでUACに対応した動作になり、VirtualStoreを無効化できます。<br>
<br>
<small>*sakura.exe.manifestの内容は頁末参照</small><br>

<h3>VirtualStoreとは</h3>
Program FilesフォルダやWindowsフォルダ配下に設定を保存するようなVista未対応のアプリが、Vista上では急に動かなくなってしまうことが無いように設けられた互換性維持機能です。
Vista未対応アプリはVirtualStore有効で動作します。VirtualStore有効のアプリがProgram Filesのように保護強化されたフォルダにファイルを保存しようとすると、目的のフォルダではなくVirtual Storeと呼ばれる別のフォルダにファイルが保存され、
以後、同じファイルを開こうとしたときにはVirtual Store側にあるファイルが開かれる仕組みになっています。

<h3>VirtualStore有効時の問題</h3>
VirtualStore有効のままでアプリを使用していると、そのアプリで保護フォルダのファイルを操作したときに次のような混乱が起きます。
<ul>
<li>新規保存したはずなのにエクスプローラで見るとファイルが見つからない</li>
<li>上書き保存したのにメモ帳で見ると内容が更新されていない</li>
<li>エクスプローラでファイルを上書きしたのに開いてみると更新されていない</li>
</ul>

アプリに適用されるVirtualStoreを無効にすれば、保護フォルダへの書き込みは通常通り拒否され、保護フォルダのファイルを開こうとしてVirtual Store側のファイルが開かされることもないので、上記のような混乱も起きなくなります。

<h3>VirtualStoreを無効にする場合の注意事項</h3>
必ず<a href="HLP000078.html">マルチユーザー化</a>も適用し、設定がユーザー別設定フォルダに保存されるようにしてください。
その際、マルチユーザー構成設定ファイル<em>sakura.exe.ini</em>の編集はデスクトップなどの非保護フォルダで行い、編集後のファイルをエクスプローラでコピーしてください。
<br>
既に、ユーザー別設定を適用せずにProgram Filesにインストールして使用している場合はインストール先フォルダ下の設定ファイルやその他のファイルがVirtual Storeに転送されている可能性があります。
エクスプローラで確認して転送ファイルのほうを優先的にユーザー別設定フォルダにコピーしてください。
<br>
<br>
Program Filesではなく、保護対象外のフォルダにインストールして使用する場合はユーザー別設定にする必要はありません。<br>
<br>

1.5.17.0以前のバージョンではマルチユーザー化に対応していないため、VirtualStore無効での利用ができません。

<h3>Virtual Storeに転送されたファイルの確認方法</h3>
フォルダの仮想化されたファイル（Virtual Storeに転送されたファイル）を表示するにはエクスプローラのツールバーに表示される [互換性ファイル]ボタンをクリックします。
[互換性ファイル]ボタンは、そのフォルダに仮想化されたファイルがある場合にのみ表示されます。<br>
<br>
実際のパスは、たとえばProgram Files\sakuraにインストールされているとき、<em>C:\Users\&lt;username&gt;\AppData\Local\VirtualStore\Program Files\sakura</em> が転送先になります。

<h2>sakura.exe.manifestの内容</h2>
以下の内容のファイルをsakura.exeと同じ場所に保存します。<em>sakura.exe.manifest</em>自身がVirtualStoreに入らないように注意してください。<br>
<small>*デスクトップなどの非保護フォルダで編集を済ませてエクスプローラでコピーなど。</small>

<h3>VisualStyle有効のみ</h3>
XP以降のVisualStyleを有効にする例です。
<pre style = "border:1px solid;">
&lt;?xml version="1.0" encoding="UTF-8" standalone="yes"?&gt;
&lt;assembly xmlns="urn:schemas-microsoft-com:asm.v1" manifestVersion="1.0"&gt;

&lt;description&gt;サクラエディタ&lt;/description&gt;
&lt;dependency&gt;
    &lt;dependentAssembly&gt;
        &lt;assemblyIdentity
            type="win32"
            name="Microsoft.Windows.Common-Controls"
            version="6.0.0.0"
            processorArchitecture="X86"
            publicKeyToken="6595b64144ccf1df"
            language="*"
        /&gt;
    &lt;/dependentAssembly&gt;
&lt;/dependency&gt;
&lt;/assembly&gt;
</pre>

<h3>VisualStyle有効およびUAC対応</h3>
VisualStyleを有効にし、VirtualStoreを無効(UAC対応)にする例です。
<pre style = "border:1px solid;">
&lt;?xml version="1.0" encoding="UTF-8" standalone="yes"?&gt;
&lt;assembly xmlns="urn:schemas-microsoft-com:asm.v1" manifestVersion="1.0"&gt;
&lt;assemblyIdentity
    name="sakura"
    processorArchitecture="x86"
    version="1.0.0.0"
    type="win32"/&gt;
&lt;description&gt;Sakura Editor&lt;/description&gt;
&lt;dependency&gt;
    &lt;dependentAssembly&gt;
        &lt;assemblyIdentity
            type="win32"
            name="Microsoft.Windows.Common-Controls"
            version="6.0.0.0"
            processorArchitecture="*"
            publicKeyToken="6595b64144ccf1df"
            language="*"
        /&gt;
    &lt;/dependentAssembly&gt;
&lt;/dependency&gt;
&lt;trustInfo xmlns="urn:schemas-microsoft-com:asm.v3"&gt;
    &lt;security&gt;
        &lt;requestedPrivileges&gt;
            &lt;requestedExecutionLevel level="asInvoker" uiAccess="false"/&gt;
        &lt;/requestedPrivileges&gt;
    &lt;/security&gt;
&lt;/trustInfo&gt;
&lt;/assembly&gt;
</pre>
</BODY></HTML>
